{% block content %}
{% load static %}

<div class="robot">
  <!-- Toggle Button -->
  <button id="chatbot-toggle" onclick="toggleChatbot()">
    <img src="/static/images/chatbot.png" alt="Chatbot Toggle" />
  </button>
  <!-- Chatbot Popup -->
  <div id="chatbot-popup" style="display: none;">
    <!-- Chatbot Header -->
    <div id="chatbot-header">
      <h3>Duckbot</h3>
      <button id="close-chatbot" onclick="toggleChatbot()">&times;</button>
    </div>

    <!-- Chat Messages -->
    <div class="chat-area" id="message-box"></div>

    <!-- Input Area -->
    <div class="input-div">
      <form id="chatbot-form" onsubmit="send(event)">
        <input
          class="input-message"
          name="message"
          type="text"
          id="message"
          placeholder="Type your message ..."
        />
        <button class="input-send" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<style>
  /* Robot container */
  .robot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  /* Toggle button */
  #chatbot-toggle {
    position: fixed;
    top: 10%;
    right: 50px;
    width: 60px;
    height: 60px;
    border: none;
    background-color: transparent;
    cursor: pointer;
    z-index: 1001;
  }

  #chatbot-toggle img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  }

  /* Chatbot Popup */
  #chatbot-popup {
    display: none;
    width: 300px;
    position: fixed;
    bottom: 120px;
    right: 50px;
    background-color: #ffeb3b;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    z-index: 1000;
  }

  /* Header styles */
  #chatbot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: "Comic Sans MS", sans-serif;
    color: #333;
  }

  #close-chatbot {
    border: none;
    background: #ffd54f;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease, background-color 0.2s ease;
  }

  #close-chatbot:hover {
    background-color: #ffcc80;
    transform: scale(1.1);
  }

  /* Chat Messages */
  .chat-area {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
    font-family: Arial, sans-serif;
  }

  .chat-message-sent {
    background-color: lavender;
    margin: 8px 16px 8px auto;
    padding: 10px;
    border-radius: 12px 12px 2px 12px;
    color: black;
  }

  .chat-message-received {
    background-color: white;
    margin: 8px auto 8px 16px;
    padding: 10px;
    border-radius: 12px 12px 12px 2px;
    color: black;
  }

  /* Input Area */
  .input-div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: transparent;
    padding: 10px 0;
  }

  .input-message {
    width: calc(100% - 50px);
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-family: "Arial", sans-serif;
  }

  .input-send {
    padding: 10px;
    background-color: #ff9800;
    border: none;
    border-radius: 10px;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
  }

  .input-send:hover {
    background-color: #ffcc80;
  }
</style>

<script>
  // Función para mostrar/ocultar el chatbot
  function toggleChatbot() {
    const popup = document.getElementById("chatbot-popup");
    const toggleButton = document.getElementById("chatbot-toggle");

    if (popup.style.display === "none" || popup.style.display === "") {
      popup.style.display = "block"; // Mostrar el popup
      toggleButton.style.display = "none"; // Ocultar el botón
    } else {
      popup.style.display = "none"; // Ocultar el popup
      toggleButton.style.display = "block"; // Mostrar el botón
    }
  }

  // Para enviar mensajes (simulado con fetch y CSRF incluido)
  var running = false;
  function send(event) {
    event.preventDefault();

    if (running) return;

    const messageInput = document.getElementById("message");
    const msg = messageInput.value.trim();
    if (!msg) return;

    running = true;
    addMsg(msg);
    messageInput.value = "";

    fetch("{% url 'chatbot_view' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"),
      },
      body: JSON.stringify({ message: msg }),
    })
      .then((response) => response.json())
      .then((data) => {
        addResponseMsg(data.bot_message || "Error: Could not understand.");
      })
      .catch((error) => {
        console.error("Error communicating with chatbot:", error);
        addResponseMsg("Error occurred. Please try later.");
      })
      .finally(() => (running = false));
  }

  // Agrega el mensaje enviado
  function addMsg(msg) {
    const messages = document.getElementById("message-box");
    const div = document.createElement("div");
    div.className = "chat-message-sent";
    div.textContent = msg;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // Agrega la respuesta del bot
  function addResponseMsg(msg) {
    const messages = document.getElementById("message-box");
    const div = document.createElement("div");
    div.className = "chat-message-received";
    div.textContent = msg;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  // Obtener CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
      const cookies = document.cookie.split(";");
      cookies.forEach((cookie) => {
        const trimmed = cookie.trim();
        if (trimmed.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }
</script>



{% endblock %}